function safe_add(e,t){var n=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(n>>16)<<16|65535&n}function rol(e,t){return e<<t|e>>>32-t}function cmn(e,t,n,i,s,a){return safe_add(rol(safe_add(safe_add(t,e),safe_add(i,a)),s),n)}function ff(e,t,n,i,s,a,o){return cmn(t&n|~t&i,e,t,s,a,o)}function gg(e,t,n,i,s,a,o){return cmn(t&i|n&~i,e,t,s,a,o)}function hh(e,t,n,i,s,a,o){return cmn(t^n^i,e,t,s,a,o)}function ii(e,t,n,i,s,a,o){return cmn(n^(t|~i),e,t,s,a,o)}function coreMD5(e){var t=1732584193,n=-271733879,s=-1732584194,a=271733878;for(i=0;i<e.length;i+=16){var o=t,r=n,l=s,c=a;t=ff(t,n,s,a,e[i+0],7,-680876936),a=ff(a,t,n,s,e[i+1],12,-389564586),s=ff(s,a,t,n,e[i+2],17,606105819),n=ff(n,s,a,t,e[i+3],22,-1044525330),t=ff(t,n,s,a,e[i+4],7,-176418897),a=ff(a,t,n,s,e[i+5],12,1200080426),s=ff(s,a,t,n,e[i+6],17,-1473231341),n=ff(n,s,a,t,e[i+7],22,-45705983),t=ff(t,n,s,a,e[i+8],7,1770035416),a=ff(a,t,n,s,e[i+9],12,-1958414417),s=ff(s,a,t,n,e[i+10],17,-42063),n=ff(n,s,a,t,e[i+11],22,-1990404162),t=ff(t,n,s,a,e[i+12],7,1804603682),a=ff(a,t,n,s,e[i+13],12,-40341101),s=ff(s,a,t,n,e[i+14],17,-1502002290),t=gg(t,n=ff(n,s,a,t,e[i+15],22,1236535329),s,a,e[i+1],5,-165796510),a=gg(a,t,n,s,e[i+6],9,-1069501632),s=gg(s,a,t,n,e[i+11],14,643717713),n=gg(n,s,a,t,e[i+0],20,-373897302),t=gg(t,n,s,a,e[i+5],5,-701558691),a=gg(a,t,n,s,e[i+10],9,38016083),s=gg(s,a,t,n,e[i+15],14,-660478335),n=gg(n,s,a,t,e[i+4],20,-405537848),t=gg(t,n,s,a,e[i+9],5,568446438),a=gg(a,t,n,s,e[i+14],9,-1019803690),s=gg(s,a,t,n,e[i+3],14,-187363961),n=gg(n,s,a,t,e[i+8],20,1163531501),t=gg(t,n,s,a,e[i+13],5,-1444681467),a=gg(a,t,n,s,e[i+2],9,-51403784),s=gg(s,a,t,n,e[i+7],14,1735328473),t=hh(t,n=gg(n,s,a,t,e[i+12],20,-1926607734),s,a,e[i+5],4,-378558),a=hh(a,t,n,s,e[i+8],11,-2022574463),s=hh(s,a,t,n,e[i+11],16,1839030562),n=hh(n,s,a,t,e[i+14],23,-35309556),t=hh(t,n,s,a,e[i+1],4,-1530992060),a=hh(a,t,n,s,e[i+4],11,1272893353),s=hh(s,a,t,n,e[i+7],16,-155497632),n=hh(n,s,a,t,e[i+10],23,-1094730640),t=hh(t,n,s,a,e[i+13],4,681279174),a=hh(a,t,n,s,e[i+0],11,-358537222),s=hh(s,a,t,n,e[i+3],16,-722521979),n=hh(n,s,a,t,e[i+6],23,76029189),t=hh(t,n,s,a,e[i+9],4,-640364487),a=hh(a,t,n,s,e[i+12],11,-421815835),s=hh(s,a,t,n,e[i+15],16,530742520),t=ii(t,n=hh(n,s,a,t,e[i+2],23,-995338651),s,a,e[i+0],6,-198630844),a=ii(a,t,n,s,e[i+7],10,1126891415),s=ii(s,a,t,n,e[i+14],15,-1416354905),n=ii(n,s,a,t,e[i+5],21,-57434055),t=ii(t,n,s,a,e[i+12],6,1700485571),a=ii(a,t,n,s,e[i+3],10,-1894986606),s=ii(s,a,t,n,e[i+10],15,-1051523),n=ii(n,s,a,t,e[i+1],21,-2054922799),t=ii(t,n,s,a,e[i+8],6,1873313359),a=ii(a,t,n,s,e[i+15],10,-30611744),s=ii(s,a,t,n,e[i+6],15,-1560198380),n=ii(n,s,a,t,e[i+13],21,1309151649),t=ii(t,n,s,a,e[i+4],6,-145523070),a=ii(a,t,n,s,e[i+11],10,-1120210379),s=ii(s,a,t,n,e[i+2],15,718787259),n=ii(n,s,a,t,e[i+9],21,-343485551),t=safe_add(t,o),n=safe_add(n,r),s=safe_add(s,l),a=safe_add(a,c)}return[t,n,s,a]}function binl2hex(e){for(var t="0123456789abcdef",n="",i=0;i<4*e.length;i++)n+=t.charAt(e[i>>2]>>i%4*8+4&15)+t.charAt(e[i>>2]>>i%4*8&15);return n}function binl2b64(e){for(var t="",n=0;n<32*e.length;n+=6)t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(e[n>>5]<<n%32&63|e[n>>6]>>32-n%32&63);return t}function str2binl(e){for(var t=1+(e.length+8>>6),n=new Array(16*t),i=0;i<16*t;i++)n[i]=0;for(i=0;i<e.length;i++)n[i>>2]|=(255&e.charCodeAt(i))<<i%4*8;return n[i>>2]|=128<<i%4*8,n[16*t-2]=8*e.length,n}function strw2binl(e){for(var t=1+(e.length+4>>5),n=new Array(16*t),i=0;i<16*t;i++)n[i]=0;for(i=0;i<e.length;i++)n[i>>1]|=e.charCodeAt(i)<<i%2*16;return n[i>>1]|=128<<i%2*16,n[16*t-2]=16*e.length,n}function hexMD5(e){return binl2hex(coreMD5(str2binl(e)))}function hexMD5w(e){return binl2hex(coreMD5(strw2binl(e)))}function b64MD5(e){return binl2b64(coreMD5(str2binl(e)))}function b64MD5w(e){return binl2b64(coreMD5(strw2binl(e)))}function calcMD5(e){return binl2hex(coreMD5(str2binl(e)))}function togglePassword(){const e=document.getElementById("password-input"),t=document.getElementById("eye-icon");e&&t&&("password"===e.type?(e.type="text",t.innerHTML='\n      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"\n           stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n        <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94"/>\n        <path d="M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19"/>\n        <path d="M9.9 9.9a3 3 0 0 1 4.24 4.24"/>\n        <line x1="1" y1="1" x2="23" y2="23"/>\n      </svg>\n    '):(e.type="password",t.innerHTML='\n      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"\n           stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>\n        <circle cx="12" cy="12" r="3"/>\n      </svg>\n    '))}function copyToClipboard(e){if(navigator.clipboard)navigator.clipboard.writeText(e).then(()=>{const e=document.createElement("div");e.className="copy-notification",e.textContent="✅ Copié !",e.style.cssText="\n        position: fixed;\n        top: 20px;\n        right: 20px;\n        background: #4CAF50;\n        color: white;\n        padding: 10px 15px;\n        border-radius: 5px;\n        z-index: 10000;\n        animation: fadeInOut 2s ease-in-out;\n      ",document.body.appendChild(e),setTimeout(()=>e.remove(),2e3)});else{const t=document.createElement("textarea");t.value=e,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t),alert("Identifiant copié !")}}function fillLoginForm(e,t){const n=document.getElementById("code-input")||document.querySelector('input[name="username"]'),i=document.getElementById("password-input")||document.querySelector('input[name="password"]');n&&(n.value=e,n.focus()),i&&(i.value=t),n&&(n.style.backgroundColor="#e8f5e8",setTimeout(()=>{n.style.backgroundColor=""},2e3))}function closePaymentModal(){document.getElementById("payment-modal").style.display="none",uiHandlers.stopTransactionMonitoring();const e=localStorage.getItem("dnet_credentials");if(e)try{const t=JSON.parse(e),n=document.getElementById("code-input"),i=document.getElementById("password-input");n&&i&&(n.value=t.username,i.value=t.password)}catch(e){}}function autoConnectFromCredentials(){try{const e=document.getElementById("cred-username"),t=document.getElementById("cred-password");if(!e||!t)return void alert("❌ Identifiants non trouvés dans le modal");const n=e.textContent.trim(),i=t.textContent.trim();if(!n||!i||"—"===n||"—"===i)return void alert("❌ Identifiants non valides");autoConnectAndSubmit(n,i)}catch(e){alert("❌ Erreur lors de la connexion automatique")}}function autoConnectAndSubmit(e,t){try{const n=document.getElementById("code-input"),i=document.getElementById("password-input");n&&i?(scrollToLoginForm(),n.value=e,i.value=t,highlightFilledFields(n,i),PaymentFlow.close(),setTimeout(()=>{n.focus(),n.select()},300),setTimeout(()=>{const e=document.querySelector(".submit-button");e?e.click():alert("❌ Bouton de connexion non trouvé")},2e3)):alert("❌ Champs de connexion non trouvés")}catch(e){alert("❌ Erreur lors de la connexion automatique")}}function scrollToLoginForm(){const e=document.querySelector('form[name="login"]')||document.querySelector(".login-panel");e?e.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}):window.scrollTo({top:0,behavior:"smooth"})}function highlightFilledFields(e,t){const n={backgroundColor:"#e8f5e8",borderColor:"#19c394",boxShadow:"0 0 10px rgba(25, 195, 148, 0.3)",transform:"scale(1.02)",transition:"all 0.3s ease"};Object.assign(e.style,n),Object.assign(t.style,n),e.style.animation="credentialsPulse 1s ease-in-out",t.style.animation="credentialsPulse 1s ease-in-out",setTimeout(()=>{e.style.backgroundColor="",e.style.borderColor="",e.style.boxShadow="",e.style.transform="",e.style.animation="",t.style.backgroundColor="",t.style.borderColor="",t.style.boxShadow="",t.style.transform="",t.style.animation=""},3e3)}function isValidCMLocal(e){return/^[6]\d{8}$/.test(e)}const CONFIG={firebase:{apiKey:"AIzaSyDT9KnNJgE5ShcT8KKsOj5J9cOmW6Rx3kY",authDomain:"dnet-29b02.firebaseapp.com",projectId:"dnet-29b02",storageBucket:"dnet-29b02.appspot.com",messagingSenderId:"123456789",appId:"1:123456789:web:abcdef123456"},firestore:{transactionsCollection:"transactions",realtimeOptions:{maxRetries:5,retryDelayMs:1e3,connectionTimeoutMs:1e4,enableLocalCache:!1}},zone:{id:"S78uMjeYRf11EvMIW2x3",publicKey:null},api:{cloudFunctionsUrl:"https://us-central1-dnet-29b02.cloudfunctions.net",endpoints:{getPlans:"/getPublicTicketTypes",initiatePayment:"initiatePublicPayment",checkTransaction:"checkTransactionStatus"}},fallbackPlans:[{id:"1jour",name:"1 Jour Illimité",price:500,formattedPrice:"500 F",validityText:"1 jour",isAvailable:!0},{id:"3jours",name:"3 Jours Illimité",price:1e3,formattedPrice:"1,000 F",originalPrice:1500,validityText:"3 jours",isAvailable:!0,hasPromotion:!0},{id:"1semaine",name:"1 Semaine Illimité",price:2e3,formattedPrice:"2,000 F",originalPrice:3500,validityText:"1 semaine",isAvailable:!0,hasPromotion:!0},{id:"1mois",name:"1 Mois Illimité",price:5e3,formattedPrice:"5,000 F",originalPrice:1e4,validityText:"1 mois",isAvailable:!0,hasPromotion:!0}],ui:{loaderTimeout:1e4,transactionMonitorTimeout:3e5,transactionCheckInterval:3e3,firestoreListenerTimeout:3e5}};class FirebaseIntegration{constructor(){this.functions=null,this.initialized=!1,this.defaultTimeoutMs=CONFIG?.network?.timeoutMs||1e4,this.maxRetries=CONFIG?.network?.maxRetries||4,this.baseBackoffMs=CONFIG?.network?.baseBackoffMs||600,this.maxBackoffMs=CONFIG?.network?.maxBackoffMs||5e3}async init(){try{return!!this.initialized||!(!CONFIG.firebase||!CONFIG.firebase.apiKey)&&(firebase.apps&&0!==firebase.apps.length||firebase.initializeApp(CONFIG.firebase),this.functions=firebase.functions(),this.firestore=firebase.firestore(),CONFIG.firestore&&!CONFIG.firestore.realtimeOptions.enableLocalCache&&(this.firestore.disableNetwork(),await this.firestore.enableNetwork()),this.initialized=!0,!0)}catch(e){return!1}}listenToTransaction(e,t,n){if(!this.firestore)return n?.(new Error("Firestore non disponible")),()=>{};const i=this.firestore.collection(CONFIG.firestore?.transactionsCollection||"transactions").doc(e).onSnapshot({source:"server",includeMetadataChanges:!1},e=>{try{if(!e.exists)return void n?.(new Error("Transaction non trouvée"));const i=e.data();t?.(i)}catch(e){n?.(e)}},e=>{"permission-denied"!==e.code?"unavailable"!==e.code&&n?.(e):n?.(new Error("Accès refusé à la transaction"))}),s=setTimeout(()=>{i(),n?.(new Error("Timeout de surveillance dépassé"))},CONFIG.ui?.firestoreListenerTimeout||3e5);return()=>{clearTimeout(s),i()}}async _fetchWithRetry(e,t={},{timeoutMs:n=this.defaultTimeoutMs,maxRetries:i=this.maxRetries,baseBackoffMs:s=this.baseBackoffMs,maxBackoffMs:a=this.maxBackoffMs,retryOn:o=[429,500,502,503,504]}={}){let r=0,l=null;for(;r<=i;){const c=new AbortController,d=setTimeout(()=>c.abort(),n);try{const n=await fetch(e,{...t,signal:c.signal});if(n.ok)return clearTimeout(d),n;if(o.includes(n.status)){const e=n.headers?.get?.("retry-after"),t=e?1e3*parseFloat(e):null;if(clearTimeout(d),r===i){let e=`HTTP ${n.status}`;try{e=(await n.json()).error||e}catch{}throw new Error(e)}const o=t??Math.min(a,Math.floor(s*Math.pow(1.7,r))+Math.floor(200*Math.random()));await new Promise(e=>setTimeout(e,o)),r++;continue}clearTimeout(d);let l=`HTTP ${n.status}: ${n.statusText}`;try{l=(await n.json()).error||l}catch{}throw new Error(l)}catch(e){clearTimeout(d),l=e;if("AbortError"===e?.name||e?.message?.includes("NetworkError")||e?.message?.includes("Failed to fetch")){if(r===i)break;const e=Math.min(a,Math.floor(s*Math.pow(1.7,r))+Math.floor(200*Math.random()));await new Promise(t=>setTimeout(t,e)),r++;continue}throw e}}throw l||new Error("Échec réseau après retries")}async getPlans(){try{let e=`${CONFIG.api.cloudFunctionsUrl}${CONFIG.api.endpoints.getPlans}?zoneId=${encodeURIComponent(CONFIG.zone.id)}`;CONFIG.zone.publicKey&&(e+=`&publicKey=${encodeURIComponent(CONFIG.zone.publicKey)}`);const t=await this._fetchWithRetry(e,{method:"GET",headers:{Accept:"application/json"}}),n=await t.json();if(n.success&&Array.isArray(n.plans)&&n.plans.length>0)return{success:!0,plans:n.plans,zone:n.zone};throw new Error(n.error||"Aucun forfait disponible")}catch(e){return{success:!1,error:e.message,plans:CONFIG.fallbackPlans}}}genExternalId(){return`ext_${Date.now()}_${Math.random().toString(36).slice(2,10)}`}async initiatePayment(e,t){const n=this.genExternalId(),i=`${CONFIG.api.cloudFunctionsUrl}/initiatePublicPayment`,s={planId:e,phoneNumber:t,externalId:n},a=await this._fetchWithRetry(i,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(s)});return await a.json()}async checkTransactionStatus(e){const t=`${CONFIG.api.cloudFunctionsUrl}/checkTransactionStatus?transactionId=${encodeURIComponent(e)}`,n=await this._fetchWithRetry(t,{method:"GET",headers:{Accept:"application/json"}},{timeoutMs:Math.min(this.defaultTimeoutMs,6e3),maxRetries:2,baseBackoffMs:400,maxBackoffMs:2e3});return await n.json()}async testConnection(){try{const e=`${CONFIG.api.cloudFunctionsUrl}/getPublicTicketTypes?zoneId=${encodeURIComponent(CONFIG.zone.id||"healthcheck")}`;return 404!==(await this._fetchWithRetry(e,{method:"GET",headers:{Accept:"application/json"}},{timeoutMs:5e3,maxRetries:1})).status}catch(e){return!1}}}const firebaseIntegration=new FirebaseIntegration;class UIHandlers{constructor(){this.currentTransaction=null,this.transactionMonitorInterval=null}showGlobalLoader(e,t="Chargement...",n="Veuillez patienter"){const i=document.getElementById("global-loader");if(!i)return;const s=i.querySelector(".loader-text"),a=i.querySelector(".loader-subtext");e?(s&&(s.textContent=t),a&&(a.textContent=n),i.style.display="flex",document.body.style.overflow="hidden"):(i.style.display="none",document.body.style.overflow="")}showPlansLoader(e,t=null){const n=document.getElementById("plans-loader"),i=document.getElementById("plans-grid");if(n&&i)if(e){const e=n.querySelector("p");e&&t&&(e.textContent=t),n.style.display="block",i.style.display="none"}else n.style.display="none",i.style.display="grid"}updatePlansUI(e,t=null){if(!e||0===e.length)return;const n=document.getElementById("plans-grid");if(n){if(n.innerHTML="",e.forEach((e,t)=>{const i=this.createPlanCard(e,1===t);n.appendChild(i)}),t&&t.name){const e=document.querySelector(".welcome-panel h1");e&&(e.innerHTML=`Bienvenue sur<br>${t.name}`)}this.showPlansLoader(!1)}}createPlanCard(e,t=!1){const n=document.createElement("div");n.className="plan-card "+(t?"popular":""),e.isAvailable||n.classList.add("disabled"),n.onclick=e.isAvailable?()=>PaymentFlow.open(e):()=>uiHandlers.showUnavailableMessage(e);var i;return n.innerHTML=`\n      <div class="plan-header">\n        <div class="duration">${e.name}</div>\n        <div class="plan-price">\n          ${e.hasPromotion?`<div class="price-old">${Number(e.originalPrice).toLocaleString()} F</div>`:""}\n          <div class="price">${e.formattedPrice}</div>\n        </div>\n      </div>\n      <div class="plan-details">\n        <div class="detail-row">\n          <span class="detail-icon">📶</span>\n          <span class="detail-text">↑ ${i=e.rateLimit,i&&0!==i?i>=1e3?`${(i/1e3).toFixed(0)}`:`${i}`:"Illimité"}</span>\n        </div>\n        <div class="detail-row">\n          <span class="detail-icon">⏱️</span>\n          <span class="detail-text">${e.validityText}</span>\n        </div>\n        ${e.isAvailable?"":'<div class="unavailable-notice">Temporairement épuisé</div>'}\n      </div>\n    `,n}async handlePlanClick(e){const t=prompt(`💰 ${e.name} - ${e.formattedPrice}\n\nValidité: ${e.validityText}\n\nEntrez votre numéro de téléphone Mobile Money:`);if(t)try{this.showPaymentModal(e,t);const n=await firebaseIntegration.initiatePayment(e.id,t);if(!n.success)throw new Error(n.error||"Erreur inconnue");this.showPaymentSuccess(n),this.startTransactionMonitoring(n.transactionId)}catch(e){this.showPaymentError(e.message||"Impossible d'initier le paiement")}}showUnavailableMessage(e){alert(`Oups ! Ce forfait est très demandé !\n\nLe forfait "${e.name}" n'est plus disponible pour le moment.\nNos autres offres sont toujours là pour vous !`)}showPaymentModal(e,t){const n=document.getElementById("payment-modal"),i=document.getElementById("modal-plan-title"),s=document.getElementById("payment-loader"),a=document.getElementById("payment-content");i&&(i.textContent=`${e.name} - ${e.formattedPrice}`),s&&(s.style.display="flex"),a&&(a.style.display="none"),n&&(n.style.display="flex",n.removeAttribute("aria-hidden"));const o=s?s.querySelector("p"):null;o&&(o.textContent=`Initialisation du paiement pour ${t}...`)}showPaymentSuccess(e){const t=document.getElementById("payment-loader"),n=document.getElementById("payment-content");t&&(t.style.display="none"),n&&(n.style.display="block",n.innerHTML=`\n        <div class="payment-success">\n          <div class="success-icon">✅</div>\n          <h4>Ticket réservé avec succès !</h4>\n          <p>Transaction: <strong>${e.transactionId}</strong></p>\n          <p>Montant: <strong>${Number(e.amount).toLocaleString()} F CFA</strong></p>\n          \n          <div class="payment-instructions">\n            <div class="instruction-step">\n              <span class="step-icon">📱</span>\n              <div class="step-content">\n                <strong>Vérifiez votre téléphone maintenant</strong>\n                <p>Confirmez le paiement Mobile Money pour finaliser votre achat</p>\n              </div>\n            </div>\n          </div>\n          \n          <div class="payment-timing">\n            <div class="timing-info">\n              <span class="clock-icon">⏱️</span>\n              <div class="timing-text">\n                <strong>Délai maximum: 2 minutes</strong>\n                <p>Le paiement sera automatiquement annulé si non confirmé</p>\n              </div>\n            </div>\n          </div>\n\n          <div class="transaction-status">\n            <div class="status-timer">\n              <span id="countdown-timer">2:00</span>\n            </div>\n          </div>\n        </div>\n      `,this.startPaymentCountdown())}showPaymentError(e){const t=document.getElementById("payment-loader"),n=document.getElementById("payment-content");t&&(t.style.display="none"),n&&(n.style.display="block",n.innerHTML=`\n        <div class="payment-error">\n          <div class="error-icon">❌</div>\n          <h4>Erreur de paiement</h4>\n          <p>${e}</p>\n          <button onclick="closePaymentModal()" class="retry-button">Fermer</button>\n        </div>\n      `)}startTransactionMonitoring(e){this.stopTransactionMonitoring(),this.currentTransaction=e;Date.now();this.firestoreUnsubscribe=firebaseIntegration.listenToTransaction(e,e=>{try{if("completed"===e.status)return this.showTransactionCompleted(e),void this.stopTransactionMonitoring();if("failed"===e.status||"expired"===e.status)return this.showTransactionFailed(e.providerMessage||"Paiement échoué"),void this.stopTransactionMonitoring();"pending"!==e.status&&"processing"!==e.status||this.updateTransactionStatus(e),"created"===e.status&&this.updateStatusMessage("Initiation du paiement Mobile Money...")}catch(e){this.showTransactionFailed("Erreur de traitement"),this.stopTransactionMonitoring()}},t=>{this.startPollingFallback(e)}),this.monitoringTimeout=setTimeout(()=>{this.showTransactionTimeout(),this.stopTransactionMonitoring()},CONFIG.ui?.firestoreListenerTimeout||3e5)}stopTransactionMonitoring(){this.firestoreUnsubscribe&&(this.firestoreUnsubscribe(),this.firestoreUnsubscribe=null),this.monitoringTimeout&&(clearTimeout(this.monitoringTimeout),this.monitoringTimeout=null),this.transactionMonitorInterval&&(clearTimeout(this.transactionMonitorInterval),this.transactionMonitorInterval=null),this.countdownInterval&&(clearInterval(this.countdownInterval),this.countdownInterval=null),this.currentTransaction=null}startPollingFallback(e){let t=0;const n=Date.now(),i=async()=>{if(Date.now()-n>6e4)return this.showTransactionTimeout(),void this.stopTransactionMonitoring();try{const t=await firebaseIntegration.checkTransactionStatus(e);if(t&&t.success){const e=t.transaction;if("completed"===e.status)return this.showTransactionCompleted(e),void this.stopTransactionMonitoring();if("failed"===e.status||"expired"===e.status)return this.showTransactionFailed(e.providerMessage||"Paiement échoué"),void this.stopTransactionMonitoring()}}catch(e){}t++;const s=Math.min(8e3,Math.floor(3e3*Math.pow(1.3,t)));this.transactionMonitorInterval=setTimeout(i,s)};this.transactionMonitorInterval=setTimeout(i,1e3)}updateTransactionStatus(e){const t=document.getElementById("transaction-status"),n=document.getElementById("transaction-timestamp");if(t){const n=this.getStatusDisplayText(e.status);t.textContent=n}if(n){const t=e.updatedAt?new Date(e.updatedAt).toLocaleTimeString():(new Date).toLocaleTimeString();n.textContent=`Dernière mise à jour: ${t}`}}getStatusDisplayText(e){return{created:"Transaction créée",pending:"En attente de confirmation",processing:"Traitement en cours",completed:"Terminée avec succès",failed:"Échouée",expired:"Expirée",cancelled:"Annulée"}[e]||e}startPaymentCountdown(){const e=Date.now(),t=()=>{const t=Date.now()-e,n=Math.max(0,12e4-t);if(n<=0)return void this.handlePaymentTimeout();const i=`${Math.floor(n/6e4)}:${Math.floor(n%6e4/1e3).toString().padStart(2,"0")}`,s=document.getElementById("countdown-timer");s&&(s.textContent=i,n<=3e4&&(s.style.color="#ff4444",s.style.fontWeight="bold"))};t(),this.countdownInterval=setInterval(t,1e3)}handlePaymentTimeout(){this.countdownInterval&&(clearInterval(this.countdownInterval),this.countdownInterval=null);const e=document.getElementById("payment-content");e&&(e.innerHTML='\n        <div class="payment-timeout">\n          <div class="timeout-icon">⏰</div>\n          <h4>Délai de paiement écoulé</h4>\n          <div class="timeout-explanation">\n            <p><strong>Le délai de 2 minutes est écoulé.</strong></p>\n            <p>Votre ticket a été automatiquement libéré et le paiement annulé pour éviter tout prélèvement.</p>\n          </div>\n          \n          <div class="next-steps">\n            <h5>Que faire maintenant ?</h5>\n            <div class="step-list">\n              <div class="step-item">\n                <span class="step-number">1</span>\n                <span>Réessayez avec un nouveau paiement</span>\n              </div>\n              <div class="step-item">  \n                <span class="step-number">2</span>\n                <span>Vérifiez que votre Mobile Money est actif</span>\n              </div>\n              <div class="step-item">\n                <span class="step-number">3</span>\n                <span>Contactez le support si le problème persiste</span>\n              </div>\n            </div>\n          </div>\n          \n          <div class="support-info">\n            <p><strong>Support technique:</strong></p>\n            <p>📞 +237 6 94 22 15 06</p>\n            <p>💬 WhatsApp: <a href="https://wa.me/237694221506" target="_blank">Cliquez ici</a></p>\n          </div>\n          \n          <div class="timeout-actions">\n            <button onclick="closePaymentModal()" class="retry-button">Fermer</button>\n            <button onclick="location.reload()" class="primary-button">Réessayer</button>\n          </div>\n        </div>\n      '),this.stopTransactionMonitoring()}updateStatusMessage(e){const t=document.getElementById("status-text");t&&!e.includes("Attention")&&(t.textContent=e,t.style.color="")}showTransactionCompleted(e){document.getElementById("payment-content").innerHTML=`\n      <div class="payment-completed">\n        <div class="success-icon">🎉</div>\n        <h4>Paiement réussi !</h4>\n        <p>Voici vos identifiants WiFi :</p>\n        <div class="credentials">\n          <div class="credential-item">\n            <label>Nom d'utilisateur:</label>\n            <span class="credential-value" id="final-username">${e.credentials.username}</span>\n          </div>\n          <div class="credential-item">\n            <label>Mot de passe:</label>\n            <span class="credential-value" id="final-password">${e.credentials.password}</span>\n          </div>\n        </div>\n        <div class="usage-instructions">\n          <p>✅ Utilisez ces identifiants dans le formulaire de connexion ci-dessus</p>\n          <p>⏰ Validité: ${e.ticketTypeName}</p>\n        </div>\n        \n        <div class="auto-connect-section">\n          <button onclick="autoConnectAndSubmit(document.getElementById('final-username').textContent, document.getElementById('final-password').textContent)" class="auto-connect-button">\n            🚀 Se connecter automatiquement\n          </button>\n          <button onclick="closePaymentModal()" class="close-button">Fermer</button>\n        </div>\n      </div>\n    `}showTransactionFailed(e){this.countdownInterval&&(clearInterval(this.countdownInterval),this.countdownInterval=null);const t=document.getElementById("payment-content");if(!t)return;const n="string"==typeof e?e:e?.providerMessage||"Le paiement n'a pas pu être traité.";t.innerHTML=`\n      <div class="payment-failed">\n        <div class="error-icon">❌</div>\n        <h4>Paiement non confirmé</h4>\n        <div class="error-explanation">\n          <p><strong>Le paiement n'a pas pu être finalisé.</strong></p>\n          <p class="error-message">${n}</p>\n        </div>\n        \n        <div class="failure-reasons">\n          <h5>Causes possibles :</h5>\n          <ul>\n            <li>Paiement refusé sur votre téléphone</li>\n            <li>Solde insuffisant sur votre compte Mobile Money</li>\n            <li>Problème technique temporaire</li>\n            <li>Délai de confirmation dépassé (2 minutes)</li>\n          </ul>\n        </div>\n        \n        <div class="failure-actions">\n          <h5>Solutions :</h5>\n          <div class="action-buttons">\n            <button onclick="location.reload()" class="retry-button primary">\n              🔄 Réessayer le paiement\n            </button>\n            <button onclick="closePaymentModal()" class="secondary-button">\n              Fermer\n            </button>\n          </div>\n        </div>\n        \n        <div class="support-contact">\n          <p><strong>Besoin d'aide ?</strong></p>\n          <p>📞 Support: +237 6 94 22 15 06</p>\n          <p>💬 <a href="https://wa.me/237694221506" target="_blank">WhatsApp</a></p>\n        </div>\n      </div>\n    `}showTransactionTimeout(){const e=document.getElementById("payment-content");e&&(e.innerHTML='\n      <div class="payment-timeout">\n        <div class="warning-icon">⏱️</div>\n        <h4>Délai d\'attente dépassé</h4>\n        <p>La vérification du paiement prend plus de temps que prévu.</p>\n        <p>Vérifiez votre téléphone ou contactez le support si le problème persiste.</p>\n        <button onclick="closePaymentModal()" class="close-button">Fermer</button>\n      </div>\n    ')}}const uiHandlers=new UIHandlers,TicketStore={KEY:"dnet_tickets",all(){try{return JSON.parse(localStorage.getItem(this.KEY)||"[]")}catch{return[]}},add(e){const t=this.all();t.unshift({...e,savedAt:Date.now()}),localStorage.setItem(this.KEY,JSON.stringify(t.slice(0,100)))},clear(){localStorage.removeItem(this.KEY)}},MyTickets={open(){const e=document.getElementById("tickets-modal");this.render(),e.style.display="flex",e.setAttribute("aria-hidden","false")},close(){const e=document.getElementById("tickets-modal");e.style.display="none",e.setAttribute("aria-hidden","true")},clearAll(){confirm("Supprimer tous les tickets enregistrés sur cet appareil ?")&&(TicketStore.clear(),this.render())},render(){const e=document.getElementById("tickets-list"),t=TicketStore.all();t.length?(e.innerHTML="",t.forEach(t=>{const n=document.createElement("div");n.className="ticket-item";const i=new Date(t.savedAt||Date.now()).toLocaleString();n.innerHTML=`\n        <div><strong>${t.planName||"Ticket"}</strong><div class="kv">Acheté le ${i}</div></div>\n        <div class="kv">Validité: <strong>${t.validityText||"-"}</strong><br>Montant: <strong>${t.amount&&t.amount.toLocaleString?t.amount.toLocaleString():t.amount||"-"} F</strong></div>\n        <div>\n          <div>👤 <span class="cred">${t.username}</span></div>\n          <div>🔑 <span class="cred">${t.password}</span></div>\n          <div class="ticket-actions">\n            <button class="copy-btn" onclick="MyTickets.copyCreds('${t.username}','${t.password}')">Copier</button>\n            <button class="use-ticket-btn" onclick="MyTickets.useTicket('${t.username}','${t.password}')">🚀 Utiliser ce ticket</button>\n          </div>\n        </div>\n      `,e.appendChild(n)})):e.innerHTML='<div class="t-muted">Aucun ticket enregistré pour le moment.</div>'},copyCreds(e,t){const n=`Utilisateur: ${e}\nMot de passe: ${t}`;navigator.clipboard?.writeText(n),alert("Identifiants copiés.")},useTicket(e,t){try{this.close(),setTimeout(()=>{scrollToLoginForm()},100),setTimeout(()=>{const n=document.getElementById("code-input"),i=document.getElementById("password-input");n&&i?(n.value=e,i.value=t,highlightFilledFields(n,i),n.focus(),n.select(),this._showTicketUsedNotification()):alert("❌ Formulaire de connexion non trouvé")},500)}catch(e){alert("❌ Erreur lors de l'utilisation du ticket")}},_showTicketUsedNotification(){const e=document.createElement("div");if(e.innerHTML='\n      <div style="display: flex; align-items: center; gap: 10px;">\n        <span style="font-size: 24px;">✅</span>\n        <div>\n          <div style="font-weight: 600;">Ticket utilisé !</div>\n          <div style="font-size: 14px; opacity: 0.9;">Formulaire rempli automatiquement ci-dessus</div>\n        </div>\n      </div>\n    ',e.style.cssText="\n      position: fixed;\n      top: 20px;\n      left: 50%;\n      transform: translateX(-50%);\n      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);\n      color: white;\n      padding: 15px 25px;\n      border-radius: 12px;\n      z-index: 10001;\n      box-shadow: 0 8px 25px rgba(0,0,0,0.15);\n      animation: slideDownBounce 0.5s ease-out;\n      max-width: 300px;\n      text-align: center;\n    ",!document.querySelector("#enhanced-notification-style")){const e=document.createElement("style");e.id="enhanced-notification-style",e.textContent="\n        @keyframes slideDownBounce {\n          0% { \n            transform: translateX(-50%) translateY(-30px) scale(0.8); \n            opacity: 0; \n          }\n          60% { \n            transform: translateX(-50%) translateY(5px) scale(1.05); \n            opacity: 1; \n          }\n          100% { \n            transform: translateX(-50%) translateY(0) scale(1); \n            opacity: 1; \n          }\n        }\n      ",document.head.appendChild(e)}document.body.appendChild(e),setTimeout(()=>{e.style.animation="slideDownBounce 0.3s ease-out reverse",setTimeout(()=>e.remove(),300)},4e3)}};document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("btn-my-tickets");e&&e.addEventListener("click",()=>MyTickets.open())});const PhoneMemory={KEY:"dnet_last_phone",get(){try{return localStorage.getItem(this.KEY)||""}catch{return""}},set(e){try{localStorage.setItem(this.KEY,e)}catch{}}},PaymentFlow={_interval:null,_txId:null,_plan:null,_firestoreUnsubscribe:null,_countdownInterval:null,_currentStep:1,_resetAll(){this._stop(),this._interval=null,this._txId=null,this._plan=null,this._firestoreUnsubscribe=null,this._countdownInterval=null,this._currentStep=1,this._resetUI()},_resetUI(){document.querySelectorAll("#pay-steps li").forEach(e=>{e.classList.remove("active")}),document.querySelector('#pay-steps li[data-step="1"]')?.classList.add("active");const e=document.getElementById("btn-start-payment");e&&(e.disabled=!0,e.onclick=null),["stage-init","stage-pending","stage-success","stage-failed"].forEach(e=>{const t=document.getElementById(e);t&&(t.style.display="none",t.innerHTML="")}),this._setDefaultContent()},_setDefaultContent(){const e=document.getElementById("stage-init");e&&(e.innerHTML='\n        <div class="spinner"></div>\n        <p>Connexion au service de paiement…</p>\n      ');const t=document.getElementById("stage-pending");t&&(t.innerHTML='\n        <div class="spinner"></div>\n        <button class="link-button" id="btn-resend-check">Rafraîchir l\'état</button>\n      ');const n=document.getElementById("stage-success");n&&(n.innerHTML='\n        <div class="big-icon">🎉</div>\n        <h4>Paiement validé</h4>\n        <p>Voici vos identifiants Wi-Fi :</p>\n        <div class="credentials">\n          <div class="credential-item">\n            <label>Nom d\'utilisateur :</label>\n            <span class="credential-value" id="cred-username">—</span>\n          </div>\n          <div class="credential-item">\n            <label>Mot de passe :</label>\n            <span class="credential-value" id="cred-password">—</span>\n          </div>\n        </div>\n        <div class="auto-connect-section">\n          <button onclick="autoConnectFromCredentials()" class="auto-connect-button">\n            🚀 Se connecter automatiquement\n          </button>\n        </div>\n        <button class="close-button" onclick="PaymentFlow.close()">Fermer</button>\n      ');const i=document.getElementById("stage-failed");i&&(i.innerHTML='\n        <div class="big-icon error">❌</div>\n        <h4>Le paiement a échoué</h4>\n        <p id="fail-reason">Une erreur est survenue.</p>\n        <button class="retry-button" onclick="PaymentFlow.close()">Fermer</button>\n      ')},open(e,t=""){this._resetAll(),this._plan=e,this._currentStep=1,document.getElementById("modal-plan-title").textContent=`💰 Paiement — ${e.name}`,document.getElementById("sum-name").textContent=e.name,document.getElementById("sum-price").textContent=e.formattedPrice||`${e.price?.toLocaleString?.()||e.price} F`,this.setStep(1),document.getElementById("phone-capture").style.display="block",this.showStage(null);const n=document.getElementById("pay-phone"),i=t||PhoneMemory.get();n.value=(i||"").replace(/\D/g,"").slice(-9),this._currentPhone=n.value,this._toggleStartButton(),n.oninput=()=>{this._currentPhone=n.value,this._toggleStartButton()},document.getElementById("btn-start-payment").onclick=()=>this._proceedFromPhone();const s=document.getElementById("payment-modal");s.style.display="flex",s.setAttribute("aria-hidden","false"),setTimeout(()=>n.focus(),50)},close(){const e=document.getElementById("cred-username"),t=document.getElementById("cred-password");let n=!1;if(e&&t){const i=e.textContent.trim(),s=t.textContent.trim();i&&s&&"—"!==i&&"—"!==s&&(setTimeout(()=>{scrollToLoginForm()},200),setTimeout(()=>{const e=document.getElementById("code-input"),t=document.getElementById("password-input");e&&t&&(e.value=i,t.value=s,highlightFilledFields(e,t),e.focus(),e.select(),n=!0,this._showAutoFillNotification())},700))}const i=document.getElementById("payment-modal");i.style.display="none",i.setAttribute("aria-hidden","true"),setTimeout(()=>{this._resetAll()},100)},_showAutoFillNotification(){const e=document.querySelector(".autofill-notification");e&&e.remove();const t=document.createElement("div");t.className="autofill-notification",t.innerHTML='\n      <div class="notification-content">\n        <span class="notification-icon">✅</span>\n        <div class="notification-text">\n          <strong>Identifiants récupérés !</strong>\n          <small>Les champs ont été préremplis automatiquement</small>\n        </div>\n        <button class="notification-close" onclick="this.parentElement.parentElement.remove()">×</button>\n      </div>\n    ',document.body.appendChild(t),setTimeout(()=>{t.parentNode&&t.remove()},5e3)},setStep(e){this._currentStep=e,document.querySelectorAll("#pay-steps li").forEach(t=>{t.classList.toggle("active",Number(t.dataset.step)===e)})},showStage(e){["stage-init","stage-pending","stage-success","stage-failed"].forEach(t=>{const n=document.getElementById(t);n&&(n.style.display=e&&t===e?"block":"none")})},_toggleStartButton(){const e=isValidCMLocal(document.getElementById("pay-phone").value.trim());document.getElementById("btn-start-payment").disabled=!e},async _proceedFromPhone(){const e=document.getElementById("pay-phone").value.trim();if(!isValidCMLocal(e))return;const t=`237${e}`;this._currentPhone=t,PhoneMemory.set(e),this.setStep(2),this._currentStep=2,document.getElementById("phone-capture").style.display="none",this.showStage("stage-init"),await this._init(t)},async _init(e){try{this.showStage("stage-init"),this._updateInitMessage("🚀 Préparation de votre commande...","Nous réservons votre forfait et préparons le paiement.<br>Plus que quelques secondes ! ⏳");const t=await firebaseIntegration.initiatePayment(this._plan.id,e);if(!t||!t.success)throw new Error(t?.error||"Échec de l'initiation");this._txId=t.transactionId,this._showPaymentSuccess(t),this._start()}catch(e){this._showInitError(e.message)}},_updateInitMessage(e,t){document.getElementById("stage-init").innerHTML=`\n      <div class="spinner"></div>\n      <h4>${e}</h4>\n      <p>${t}</p>\n    `},_showPaymentSuccess(e){this.setStep(2),this.showStage("stage-pending"),document.getElementById("stage-pending").innerHTML='\n      <h4>Validez le paiement du ticket</h4>\n      \n      <div class="payment-instructions">\n        <p>\n          1️⃣ <strong>Entrez votre code</strong><br>\n          2️⃣ Attendez quelques secondes<br>\n          3️⃣ Nous verifions le statut de la transaction <span class="loader-inline"></span>\n        </p>\n      </div>\n      \n      <div class="payment-timing">\n        <div class="timing-info">\n          <div class="timing-text">\n            <strong>Vous avez 2 minutes pour confirmer</strong>\n            <p>Aucun débit ne sera effectué sans votre confirmation&nbsp;!</p>\n          </div>\n        </div>\n      </div>\n\n      <div class="transaction-status">\n        <div class="status-timer">\n          <span id="countdown-timer">2:00</span>\n        </div>\n      </div>\n      \n      <button class="link-button" id="btn-resend-check" onclick="PaymentFlow._tick()">🔍 Vérifier maintenant</button>\n    ',this._startPaymentCountdown()},_showInitError(e){this.setStep(1),this.showStage("stage-failed"),document.getElementById("stage-failed").innerHTML=`\n      <div class="big-icon error">😅</div>\n      <h4>Une petite pause technique !</h4>\n      <p>Nous n'avons pas pu préparer votre commande.</p>\n      \n      <div class="error-explanation">\n        <p><strong>Message d'erreur :</strong> ${e}</p>\n      </div>\n      \n      <div class="failure-reasons">\n        <h5>💡 Quelques suggestions :</h5>\n        <ul>\n          <li>Vérifiez votre connexion internet</li>\n          <li>Réessayez dans 30 secondes</li>\n          <li>Ce forfait est peut-être épuisé</li>\n        </ul>\n      </div>\n      \n      <div class="action-buttons">\n        <button onclick="location.reload()" class="retry-button primary">🔄 Pas de souci, réessayons ensemble !</button>\n        <button onclick="PaymentFlow.close()" class="secondary-button">Plus tard</button>\n      </div>\n    `},_startPaymentCountdown(){const e=Date.now(),t=()=>{const t=Date.now()-e,n=Math.max(0,12e4-t);if(n<=0)return void this._handlePaymentTimeout();const i=`${Math.floor(n/6e4)}:${Math.floor(n%6e4/1e3).toString().padStart(2,"0")}`,s=document.getElementById("countdown-timer");s&&(s.textContent=i,n<=3e4?(s.style.color="#ff4444",s.style.fontWeight="bold"):n<=6e4&&(s.style.color="#ff8800"))};t(),this._countdownInterval=setInterval(t,1e3)},_handlePaymentTimeout(){this._countdownInterval&&(clearInterval(this._countdownInterval),this._countdownInterval=null),this.showStage("stage-failed"),document.getElementById("stage-failed").innerHTML='\n      <div class="big-icon error">⏰</div>\n      <h4>Temps écoulé, mais pas de panique !</h4>\n      \n      <div class="timeout-explanation">\n        <p><strong>Votre réservation a expiré après 2 minutes d\'attente.</strong></p>\n        <p>Bonne nouvelle : aucun débit n\'a eu lieu sur votre compte ! 😊</p>\n      </div>\n      \n      <div class="next-steps">\n        <h5>🔄 Que faire maintenant ?</h5>\n        <div class="step-list">\n          <div class="step-item">\n            <span class="step-number">1</span>\n            <span>Recommencez simplement votre commande</span>\n          </div>\n          <div class="step-item">\n            <span class="step-number">2</span>\n            <span>Vérifiez que votre Mobile Money fonctionne</span>\n          </div>\n          <div class="step-item">\n            <span class="step-number">3</span>\n            <span>Soyez plus rapide pour confirmer (vous avez 2 minutes)</span>\n          </div>\n        </div>\n      </div>\n      \n      <div class="support-info">\n        <p><strong>💡 Astuce :</strong> Gardez votre téléphone à portée de main !</p>\n        <p>📞 Besoin d\'aide ? Appelez-nous : +237 6 94 22 15 06</p>\n        <p>💬 Ou écrivez-nous sur <a href="https://wa.me/237694221506" target="_blank">WhatsApp</a></p>\n      </div>\n      \n      <div class="timeout-actions">\n        <button onclick="location.reload()" class="retry-button primary">🔄 Recommencer</button>\n        <button onclick="PaymentFlow.close()" class="secondary-button">❌ Annuler</button>\n      </div>\n    ',this._stop()},_start(){this._firestoreUnsubscribe=firebaseIntegration.listenToTransaction(this._txId,e=>{try{const t=e;if("completed"===t.status&&t.credentials)return this.setStep(3),this.showStage("stage-success"),document.getElementById("stage-success").innerHTML=`\n            <h4>Voici vos codes d'accès WiFi </h4>\n            \n            <div class="credentials">\n              <div class="credential-item">\n                <label>🆔 Votre identifiant:</label>\n                <span class="credential-value" id="cred-username">${t.credentials.username}</span>\n              </div>\n              <div class="credential-item">\n                <label>🔐 Votre mot de passe:</label>\n                <span class="credential-value" id="cred-password">${t.credentials.password}</span>\n              </div>\n            </div>\n\n            <div class="auto-connect-section">\n              <button onclick="autoConnectFromCredentials()" class="auto-connect-button">\n                🚀 Me connecter maintenant\n              </button>\n            </div>\n            \n            <button class="close-button" onclick="PaymentFlow.close()">📋 Garder pour plus tard</button>\n          `,TicketStore.add({username:t.credentials.username,password:t.credentials.password,planName:this._plan.name,amount:t.amount,validityText:t.ticketTypeName||this._plan.validityText||"",freemopayReference:t.freemopayReference||null}),void this._stop();if("failed"===t.status||"expired"===t.status)return this.showStage("stage-failed"),document.getElementById("stage-failed").innerHTML='\n            <div class="big-icon error">😔</div>\n            <h4>Votre paiement n\'a pas abouti</h4>\n            \n            <p>Ne vous inquiétez pas, votre argent est en sécurité ! 💳</p>\n            \n            <div class="failure-reasons">\n              <h5>🤔 Pourquoi ça n\'a pas marché ?</h5>\n              <ul>\n                <li>Vous avez peut-être refusé sur votre téléphone</li>\n                <li>Solde insuffisant sur votre compte Mobile Money</li>\n                <li>Petit problème technique temporaire</li>\n                <li>Confirmation trop tardive (plus de 2 minutes)</li>\n              </ul>\n            </div>\n            \n            <div class="failure-actions">\n              <h5>✨ Solutions simples :</h5>\n              <ul>\n                <li>Vérifiez votre solde Mobile Money</li>\n                <li>Réessayez en confirmant plus rapidement</li>\n                <li>Contactez-nous si ça persiste</li>\n              </ul>\n            </div>\n            \n            <div class="action-buttons">\n              <button onclick="location.reload()" class="retry-button primary">🔄 Retenter ma chance</button>\n              <button onclick="PaymentFlow.close()" class="secondary-button">❌ Peut-être plus tard</button>\n            </div>\n            \n            <div class="support-contact">\n              <p><strong>🆘 Une question ? On est là !</strong></p>\n              <p>📞 +237 6 94 22 15 06 | 💬 <a href="https://wa.me/237694221506" target="_blank">WhatsApp</a></p>\n            </div>\n          ',void this._stop()}catch(e){this._handleError("Erreur de traitement")}},e=>{this._startPollingFallback()})},_stop(){if(this._firestoreUnsubscribe){try{this._firestoreUnsubscribe()}catch(e){}this._firestoreUnsubscribe=null}this._interval&&(clearInterval(this._interval),this._interval=null),this._countdownInterval&&(clearInterval(this._countdownInterval),this._countdownInterval=null),this._removeGlobalEventListeners()},_removeGlobalEventListeners(){["btn-start-payment","btn-resend-check"].forEach(e=>{const t=document.getElementById(e);t&&(t.onclick=null)});["pay-phone"].forEach(e=>{const t=document.getElementById(e);t&&(t.oninput=null)})},_startPollingFallback(){this._interval=setInterval(()=>this._tick(),CONFIG.ui?.transactionCheckInterval||4e3)},getStatusText:e=>({created:"Créée",pending:"En attente",processing:"En cours",completed:"Terminée",failed:"Échouée",expired:"Expirée"}[e]||e),_handleError(e){this.showStage("stage-failed"),document.getElementById("fail-reason").textContent=e,this._stop()},async _tick(){if(this._txId)try{const e=await firebaseIntegration.checkTransactionStatus(this._txId);if(!e?.success)return;const t=e.transaction||{};if("completed"===t.status&&t.credentials&&t.credentials.username&&t.credentials.password&&""!==t.credentials.username.trim()&&""!==t.credentials.password.trim()){this.setStep(3),this.showStage("stage-success");const e=document.getElementById("cred-username"),n=document.getElementById("cred-password");return e&&n&&(e.textContent=t.credentials.username,n.textContent=t.credentials.password,TicketStore.add({username:t.credentials.username,password:t.credentials.password,planName:t.planName||this._plan?.name||"Forfait",amount:t.amount,validityText:t.ticketTypeName||this._plan?.validityText||"",freemopayReference:t.freemopayReference||null,purchaseDate:(new Date).toISOString(),transactionId:this._txId})),void this._stop()}if("failed"===t.status||"expired"===t.status){this.showStage("stage-failed");const e=document.getElementById("fail-reason");if(e){const n={failed:"Le paiement a échoué. Votre argent est sécurisé.",expired:"Le délai de paiement a expiré. Veuillez réessayer."};e.textContent=n[t.status]||"Une erreur est survenue."}return void this._stop()}if("pending"===t.status||"created"===t.status){const e=document.getElementById("live-status");if(e){const n={created:"Transaction initiée...",pending:"En attente de confirmation..."};e.textContent=n[t.status]||"Vérification en cours..."}}}catch(e){}else this._stop()}};class HotspotApp{constructor(){this.initialized=!1}async init(){try{uiHandlers.showPlansLoader(!0,"Initialisation...");await firebaseIntegration.init()?uiHandlers.showPlansLoader(!0,"Chargement des forfaits..."):uiHandlers.showPlansLoader(!0,"Mode hors ligne..."),await this.loadPlans(),this.initialized=!0,setTimeout(()=>{uiHandlers.showPlansLoader(!1)},500)}catch(e){this.handleInitError(e)}}async loadPlans(){try{uiHandlers.showPlansLoader(!0);const e=new Promise((e,t)=>{setTimeout(()=>t(new Error("Timeout de chargement")),CONFIG.ui.loaderTimeout)}),t=await Promise.race([firebaseIntegration.getPlans(),e]);if(!t.success)throw new Error(t.error||"Erreur inconnue");uiHandlers.updatePlansUI(t.plans,t.zone)}catch(e){this.useFallbackPlans()}}useFallbackPlans(){const e=document.getElementById("plans-grid");e&&(e.style.display="none");const t=document.querySelector(".plans-cta");t&&(t.style.display="none"),this.showContactSupportMessage()}handleInitError(e){uiHandlers.showPlansLoader(!1),this.useFallbackPlans()}showContactSupportMessage(){const e=document.createElement("div");e.className="contact-support-notification",e.innerHTML='\n      <div class="support-content">\n        <div class="support-icon">📞</div>\n        <h3>Service Temporairement Indisponible</h3>\n        <p>Nous ne pouvons pas charger les forfaits automatiques actuellement.</p>\n        <p><strong>Pour acheter un forfait, contactez-nous directement :</strong></p>\n        \n        <div class="contact-methods">\n          <a href="tel:+237694221506" class="contact-button phone">\n            📞 Appeler +237 6 94 22 15 06\n          </a>\n          <a href="https://wa.me/237694221506" target="_blank" class="contact-button whatsapp">\n            💬 WhatsApp\n          </a>\n        </div>\n        \n        <div class="manual-payment-info">\n          <h4>Paiement Manuel Disponible</h4>\n          <p>• Paiement Orange Money / MTN Mobile Money</p>\n          <p>• Réception immédiate de vos codes d\'accès</p>\n          <p>• Support technique inclus</p>\n        </div>\n      </div>\n    ';const t=document.querySelector(".plans-info");t?t.parentNode.insertBefore(e,t.nextSibling):document.body.appendChild(e)}showErrorNotification(e){}}const hotspotApp=new HotspotApp;document.addEventListener("DOMContentLoaded",()=>{hotspotApp.init()}),window.addEventListener("error",e=>{}),window.addEventListener("unhandledrejection",e=>{}),window.addEventListener("beforeunload",()=>{uiHandlers.transactionMonitorInterval&&uiHandlers.stopTransactionMonitoring()});